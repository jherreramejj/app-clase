<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Volei ¬∑ Registro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --box-w: 230px;     /* ancho base de los cuadros */
    --box-h: 56px;      /* alto base de los cuadros */
    --gap: 14px;        /* separaci√≥n vertical entre cuadros */
    --ink: #111;        /* color borde/linea tipo maqueta */
    --paper: #fff;
    --bg: #fafafa;
    --muted: #666;
    --accent: #2d6cdf;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    background: var(--bg);
    color:#222;
  }

  /* Barra superior fija (acciones r√°pidas) */
  .topbar{
    position: sticky; top:0; z-index:10;
    background: var(--paper);
    border-bottom: 2px solid var(--ink);
    padding: 10px 16px;
  }
  .topbar .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .stat{font-size:11px; color:var(--muted)} /* reducido */
  .btn{
    border:2px solid var(--ink); background: var(--paper);
    padding:6px 10px; cursor:pointer; font-weight:600; font-size:13px; /* reducido */
  }

  main{padding: 18px 16px 28px 16px; max-width: 1200px; margin: 0 auto;}

  /* Secciones con t√≠tulo */
  .section{margin-top:18px}
  .section h2{
    font-size:18px; /* reducido */
    font-weight:700; margin:0 0 10px 0;
    padding-bottom:6px; border-bottom:2px solid var(--ink);
  }

  /* Layout columnas responsivo */
  .grid{
    display:grid;
    grid-template-columns: var(--box-w) var(--box-w) 1fr;
    gap: 28px;
    align-items:start;
  }
  @media (max-width: 980px){
    .grid{ grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 680px){
    .grid{ grid-template-columns: 1fr; }
  }

  /* ---- CUADROS DEFINIDOS (tipo maqueta) ---- */
  .box{
    width: var(--box-w); height: var(--box-h);
    border: 2px solid var(--ink);
    background: var(--paper);
    display:flex; align-items:center; justify-content:center;
    margin-bottom: var(--gap);
    cursor:pointer; user-select:none; font-size:16px; /* reducido */
    letter-spacing:.3px;
    transition: background .08s ease, transform .06s ease, outline .06s ease;
  }
  .box:hover{ background:#f7f7f7 }
  .box:active{ transform: translateY(1px) }
  .box.active{ outline:3px solid var(--accent); outline-offset:-3px; background:#eef4ff }

  /* Cuadro de entrada + bot√≥n a√±adir */
  .add-wrap{ display:flex; gap:10px; align-items:center; margin-bottom: var(--gap); }
  .box-input{
    width: var(--box-w); height: var(--box-h);
    border:2px solid var(--ink); background: var(--paper);
    display:flex; align-items:center; padding:0 12px;
  }
  .box-input input{
    width:100%; height:100%; border:none; outline:none; font-size:16px; /* reducido */
    background:transparent;
  }
  .box-add{
    width: 120px; height: var(--box-h);
    display:flex; align-items:center; justify-content:center;
    border: 2px solid var(--ink); background: var(--paper);
    cursor:pointer; font-weight:700; font-size:14px; /* reducido */
  }
  .box-add:hover{ background:#f7f7f7 }
  .box-add:active{ transform: translateY(1px) }

  /* Paneles */
  .panel{ background: var(--paper); border:2px solid var(--ink); padding:14px; }

  /* Tabla gen√©rica */
  table{ width:100%; border-collapse:collapse; font-size:12px } /* reducido */
  th,td{ border-top:1px solid #ddd; padding:8px 8px; text-align:left }
  th{ background:#f6f6f6 }

  /* Frecuencias por jugador: tarjetas */
  .freq-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
  .freq-card{ border:2px solid var(--ink); background:var(--paper); }
  .freq-card header{ padding:8px 10px; border-bottom:2px solid var(--ink); font-weight:700; display:flex; justify-content:space-between; align-items:center}
  .badge{ font-size:11px; color:var(--muted) } /* reducido */
  .freq-card table{ font-size:11px } /* reducido */

  /* Export cuadro en columna derecha */
  .right-col .box{ width: 240px }

  /* Filtro */
  .text{ padding:6px 10px; border:1px solid #bbb; background:#fff; font-size:13px }
</style>
</head>
<body>

  <!-- Barra fija -->
  <div class="topbar">
    <div class="row">
      <div class="stat">Jugador activo: <b id="currentPlayer">‚Äî</b></div>
      <div class="stat">Eventos totales: <b id="totalEvents">0</b></div>
      <button id="exportCsvBtn" class="btn">Exportar CSV</button>
      <button id="resetBtn" class="btn">Reiniciar</button>
    </div>
  </div>

  <main>
    <!-- Columnas -->
    <div class="grid">
      <!-- Jugadores -->
      <section class="section">
        <h2>Jugador</h2>

        <!-- Entrada + bot√≥n a√±adir (amigable para m√≥vil) -->
        <div class="add-wrap">
          <div class="box-input" title="Escribe y presiona A√±adir">
            <input id="newPlayerInput" placeholder="Ingreso n√∫mero de jugador" />
          </div>
          <div id="addPlayerBtn" class="box-add" role="button" aria-label="A√±adir jugador">A√±adir</div>
        </div>

        <!-- Lista de jugadores (solo cuadros para selecci√≥n r√°pida) -->
        <div id="playersList"></div>
      </section>

      <!-- Acciones -->
      <section class="section">
        <h2>Acci√≥n</h2>
        <div id="actionsList">
          <div class="box action" data-action="X5">X5</div>
          <div class="box action" data-action="V5">V5</div>
          <div class="box action" data-action="X7">X7</div>
          <div class="box action" data-action="XC">XC</div>
          <div class="box action" data-action="X1">X1</div>
          <div class="box action" data-action="X2">X2</div>
          <div class="box action" data-action="XD">XD</div>
          <div class="box action" data-action="V6">V6</div>
          <div class="box action" data-action="X6">X6</div>
          <div class="box action" data-action="X8">X8</div>
          <div class="box action" data-action="XP">XP</div>
          <div class="box action" data-action="VP">VP</div>
        </div>
      </section>

      <!-- Columna derecha -->
      <section class="section right-col">
        <h2>Opciones</h2>
        <div class="box" id="exportBox">Exportar csv</div>
      </section>
    </div>

    <!-- Tabla de eventos -->
    <section class="section panel">
      <h2 style="border-bottom:0;margin-bottom:8px">Eventos</h2>
      <div style="display:flex;gap:10px;align-items:center;margin:8px 0 12px 0;">
        <input id="filterPlayer" placeholder="Filtrar por jugador" class="text"/>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr><th>#</th><th>Fecha/Hora</th><th>Jugador</th><th>Acci√≥n</th><th>Quitar</th></tr>
          </thead>
          <tbody id="eventsTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Gr√°fica global -->
    <section class="section panel">
      <h2 style="border-bottom:0;margin-bottom:8px">Gr√°fica de frecuencias global (por acci√≥n)</h2>
      <canvas id="freqChart" height="120" style="margin-top:8px"></canvas>
    </section>

    <!-- Frecuencias por jugador (abajo) -->
    <section class="section panel">
      <h2 style="border-bottom:0;margin-bottom:8px">Frecuencias por jugador</h2>
      <div id="playersFreqSection" class="freq-grid"></div>
    </section>
  </main>

<script>
  const state = {
    currentPlayer: null,
    players: [],  // [{name}]
    events: [],   // {ts, player, action}
    actions: ["X5","V5","X7","XC","X1","X2","XD","V6","X6","X8","XP","VP"],
  };

  // Elementos
  const playersList        = document.getElementById("playersList");
  const newPlayerInput     = document.getElementById("newPlayerInput");
  const addPlayerBtn       = document.getElementById("addPlayerBtn");
  const currentPlayerSpan  = document.getElementById("currentPlayer");
  const totalEventsSpan    = document.getElementById("totalEvents");
  const eventsTbody        = document.getElementById("eventsTbody");
  const filterPlayerInput  = document.getElementById("filterPlayer");
  const exportCsvBtn       = document.getElementById("exportCsvBtn");
  const exportBox          = document.getElementById("exportBox");
  const resetBtn           = document.getElementById("resetBtn");
  const playersFreqSection = document.getElementById("playersFreqSection");

  // A√±adir jugador (click bot√≥n o Enter)
  function addPlayer() {
    const name = newPlayerInput.value.trim();
    if(!name) return;
    if(state.players.some(p => p.name === name)) { alert("Ese jugador ya existe."); return; }
    state.players.push({name});
    newPlayerInput.value = "";
    if(!state.currentPlayer) state.currentPlayer = name;
    renderPlayers(); renderGlobal(); renderPlayerFreqs(); updateChart(); renderTable();
  }
  addPlayerBtn.addEventListener("click", addPlayer);
  newPlayerInput.addEventListener("keydown", e => { if(e.key === "Enter") addPlayer(); });

  // Render: cuadros de jugador
  function renderPlayers(){
    playersList.innerHTML = "";
    state.players.forEach(p => {
      const box = document.createElement("div");
      box.className = "box";
      box.textContent = p.name;
      if(state.currentPlayer === p.name) box.classList.add("active");
      box.addEventListener("click", ()=>{
        state.currentPlayer = p.name;
        renderPlayers(); renderGlobal();
      });
      playersList.appendChild(box);
    });
  }

  // Registrar acci√≥n (Jugador+Acci√≥n)
  document.querySelectorAll(".action").forEach(el=>{
    el.addEventListener("click", ()=>{
      if(!state.currentPlayer){ alert("Primero a√±ade y selecciona un jugador."); return; }
      const action = el.dataset.action;
      const ts = new Date().toISOString();
      state.events.push({ts, player: state.currentPlayer, action});
      renderTable(); renderPlayers(); renderGlobal(); updateChart(); renderPlayerFreqs();
    });
  });

  // Tabla de eventos
  function renderTable(){
    const filter = filterPlayerInput.value.trim().toLowerCase();
    eventsTbody.innerHTML = "";
    state.events
      .map((ev,i)=>({...ev, idx:i+1}))
      .filter(ev => !filter || ev.player.toLowerCase().includes(filter))
      .forEach(ev=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ev.idx}</td>
          <td>${new Date(ev.ts).toLocaleString()}</td>
          <td>${ev.player}</td>
          <td><b>${ev.action}</b></td>
          <td><button class="btn" style="padding:2px 8px" title="Quitar">üóëÔ∏è</button></td>`;
        tr.querySelector("button").addEventListener("click", ()=>{
          const realIndex = ev.idx - 1;
          state.events.splice(realIndex, 1);
          renderTable(); renderPlayers(); renderGlobal(); updateChart(); renderPlayerFreqs();
        });
        eventsTbody.appendChild(tr);
      });
  }
  filterPlayerInput.addEventListener("input", renderTable);

  // Resumen
  function renderGlobal(){
    currentPlayerSpan.textContent = state.currentPlayer || "‚Äî";
    totalEventsSpan.textContent   = state.events.length;
  }

  // Conteo
  function countByAction(events){
    return events.reduce((acc,e)=>{
      acc[e.action] = (acc[e.action]||0)+1;
      return acc;
    },{});
  }

  // Gr√°fica global
  const chart = new Chart(document.getElementById("freqChart").getContext("2d"), {
    type:"bar",
    data:{ labels: state.actions, datasets:[{label:"Frecuencia (global)", data: state.actions.map(()=>0)}]},
    options:{ responsive:true, scales:{ y:{beginAtZero:true, ticks:{precision:0}}}}
  });
  function updateChart(){
    const freqs = countByAction(state.events);
    chart.data.datasets[0].data = state.actions.map(a=> freqs[a]||0);
    chart.update();
  }

  // Frecuencias por jugador (abajo)
  function renderPlayerFreqs(){
    playersFreqSection.innerHTML = "";
    state.players.forEach(p=>{
      const card = document.createElement("div");
      card.className = "freq-card";
      const head = document.createElement("header");
      const total = state.events.filter(e=>e.player===p.name).length;
      head.innerHTML = `<span>Jugador ${p.name}</span><span class="badge">${total} evento(s)</span>`;
      card.appendChild(head);

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Acci√≥n</th><th>Frecuencia</th></tr>";
      const tbody = document.createElement("tbody");

      const freq = countByAction(state.events.filter(e=>e.player===p.name));
      state.actions.forEach(a=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a}</td><td>${freq[a]||0}</td>`;
        tbody.appendChild(tr);
      });

      table.appendChild(thead); table.appendChild(tbody);
      card.appendChild(table);
      playersFreqSection.appendChild(card);
    });
  }

  // Export CSV
  function exportCSV(){
    if(state.events.length===0){ alert("No hay eventos para exportar."); return; }
    const header = ["timestamp","jugador","accion"];
    const rows = state.events.map(e => [e.ts, e.player, e.action]);
    const csv = [header, ...rows].map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=`volei_eventos_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  exportCsvBtn.addEventListener("click", exportCSV);
  exportBox.addEventListener("click", exportCSV);

  // Reiniciar
  resetBtn.addEventListener("click", ()=>{
    if(!confirm("¬øVaciar todos los eventos y jugadores?")) return;
    state.currentPlayer = null;
    state.players = [];
    state.events = [];
    renderPlayers(); renderPlayerFreqs(); renderTable(); renderGlobal(); updateChart();
  });

  // Init
  renderPlayers(); renderPlayerFreqs(); renderTable(); renderGlobal(); updateChart();
</script>
</body>
</html>
