<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Volley Stats · Flujo izquierda→derecha</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --box-w: 110px;    /* tamaño más pequeño */
    --box-h: 32px;
    --gap: 8px;
    --ink:#111; --paper:#fff; --bg:#fafafa; --accent:#2d6cdf;
  }
  *{box-sizing:border-box}
  body{margin:0; padding:10px; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:#222}
  h1{margin:0 0 8px 0; font-size:16px}
  .grid{display:grid; gap:12px; align-items:start; grid-template-columns: repeat(5, var(--box-w)) 1fr;}
  @media (max-width:1000px){ .grid{ grid-template-columns: repeat(3, var(--box-w)); } }
  @media (max-width:700px){ .grid{ grid-template-columns: repeat(2, var(--box-w)); } }
  .title{font-size:14px; margin-bottom:4px; text-align:center}
  .box{
    width:var(--box-w); height:var(--box-h);
    border:2px solid var(--ink); background:var(--paper);
    display:flex; align-items:center; justify-content:center;
    margin-bottom:var(--gap); cursor:pointer; user-select:none; font-size:12px;
    transition:background .08s, transform .06s, outline .06s, opacity .12s;
  }
  .box:hover{background:#f7f7f7}
  .box:active{transform:translateY(1px)}
  .box.active{outline:3px solid var(--accent); outline-offset:-3px; background:#eef4ff}
  .box.disabled{opacity:.5; pointer-events:none; filter:grayscale(.3)}
  .box-input{cursor:text; padding:0 6px; justify-content:flex-start}
  .box-input input{width:100%; height:100%; border:none; outline:none; background:transparent; font-size:12px}
  .box-add{font-weight:700}
  .row{display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-bottom:6px}
  .btn{border:2px solid var(--ink); background:#fff; padding:3px 6px; font-size:11px; cursor:pointer; font-weight:600}
  .stat{font-size:10px; color:#666}
  .panel{border:2px solid var(--ink); background:#fff; padding:8px; margin-top:10px}
  .hint{font-size:10px; color:#666; text-align:center; min-height:14px}
  .step{font-weight:700}
</style>
</head>
<body>

<h1>Volley Stats · Registro (flujo obligado izquierda→derecha)</h1>

<div class="row">
  <span class="stat">Paso: <span class="step" id="stepLabel">Llamada</span></span>
  <span class="stat">Llamada: <b id="selLlamada">—</b></span>
  <span class="stat">Jugador: <b id="selJugador">—</b></span>
  <span class="stat">Acción: <b id="selAccion">—</b></span>
  <span class="stat">Zona: <b id="selZona">—</b></span>
  <span class="stat">Valor: <b id="selValor">—</b></span>
  <span class="stat">Eventos: <b id="countEvents">0</b></span>
  <button id="resetBtn" class="btn">Reiniciar</button>
</div>

<div class="grid">
  <!-- Llamada -->
  <section>
    <div class="title">Llamada</div>
    <div class="box opt-llamada" data-llamada="K7">K7</div>
    <div class="box opt-llamada" data-llamada="KC">KC</div>
    <div class="box opt-llamada" data-llamada="K1">K1</div>
    <div class="box opt-llamada" data-llamada="K2">K2</div>
    <div class="box opt-llamada" data-llamada="KD">KD</div>
    <div class="box opt-llamada" data-llamada="KE">KE</div>
  </section>

  <!-- Jugador -->
  <section>
    <div class="title">Jugador</div>
    <div class="box box-input" title="Escribe y presiona Añadir">
      <input id="playerInput" placeholder="Ingreso número de jugador"/>
    </div>
    <div id="addPlayerBtn" class="box box-add" role="button" aria-label="Añadir jugador">Añadir</div>
    <div id="playersList"></div>
  </section>

  <!-- Acción -->
  <section>
    <div class="title">Acción</div>
    <div class="box opt-accion" data-accion="X5">X5</div>
    <div class="box opt-accion" data-accion="V5">V5</div>
    <div class="box opt-accion" data-accion="X7">X7</div>
    <div class="box opt-accion" data-accion="PP">PP</div>
    <div class="box opt-accion" data-accion="X1">X1</div>
    <div class="box opt-accion" data-accion="X2">X2</div>
    <div class="box opt-accion" data-accion="XD">XD</div>
    <div class="box opt-accion" data-accion="V6">V6</div>
    <div class="box opt-accion" data-accion="X6">X6</div>
    <div class="box opt-accion" data-accion="X8">X8</div>
    <div class="box opt-accion" data-accion="XP">XP</div>
    <div class="box opt-accion" data-accion="VP">VP</div>
  </section>

  <!-- Zona final -->
  <section>
    <div class="title">Zona final</div>
    <div class="box opt-zona" data-zona="1">1</div>
    <div class="box opt-zona" data-zona="2">2</div>
    <div class="box opt-zona" data-zona="3">3</div>
    <div class="box opt-zona" data-zona="4">4</div>
    <div class="box opt-zona" data-zona="5">5</div>
    <div class="box opt-zona" data-zona="6">6</div>
  </section>

  <!-- Valor -->
  <section>
    <div class="title">Valor</div>
    <div class="box opt-valor" data-valor="#">#</div>
    <div class="box opt-valor" data-valor="+">+</div>
    <div class="box opt-valor" data-valor="!">!</div>
    <div class="box opt-valor" data-valor="/">/</div>
    <div class="box opt-valor" data-valor="-">-</div>
    <div class="box opt-valor" data-valor="=">=</div>
    <div class="hint" id="actionHint">Sigue el orden: Llamada → Jugador → Acción → Zona → <b>Valor</b></div>
  </section>

  <!-- Export -->
  <section>
    <div class="title">&nbsp;</div>
    <div class="box" id="exportCsvBox">Exportar csv</div>
  </section>
</div>

<!-- Panel gráfico -->
<div class="panel">
  <div class="title" style="text-align:left">Frecuencias por Llamada (barras apiladas por Acción)</div>
  <canvas id="stackedChart" height="160"></canvas>
</div>

<script>
const LLAMADAS = ["K7","KC","K1","K2","KD","KE"];
const ACCIONES = ["X5","V5","X7","PP","X1","X2","XD","V6","X6","X8","XP","VP"];
const STEPS = [
  { key: "llamada", selector: ".opt-llamada", dataKey: "llamada", label: "Llamada" },
  { key: "jugador", selector: ".opt-jugador", dataKey: "jugador", label: "Jugador" },
  { key: "accion",  selector: ".opt-accion",  dataKey: "accion",  label: "Acción"  },
  { key: "zona",    selector: ".opt-zona",    dataKey: "zona",    label: "Zona"    },
  { key: "valor",   selector: ".opt-valor",   dataKey: "valor",   label: "Valor"   },
];
const state = { selected: { llamada:null, jugador:null, accion:null, zona:null, valor:null }, players: [], events: [], progress: 0 };
function $(q){ return document.querySelector(q); }
function $all(q){ return Array.from(document.querySelectorAll(q)); }
function setStepLabel(){ $("#stepLabel").textContent = STEPS[state.progress]?.label ?? "Terminado"; }
function refreshBadges(){
  selLlamada.textContent = state.selected.llamada || "—";
  selJugador.textContent = state.selected.jugador || "—";
  selAccion.textContent  = state.selected.accion  || "—";
  selZona.textContent    = state.selected.zona    || "—";
  selValor.textContent   = state.selected.valor   || "—";
  countEvents.textContent= state.events.length;
  setStepLabel();
}
function clearAfter(index){
  for(let i=index+1;i<STEPS.length;i++){
    const k = STEPS[i].key;
    state.selected[k] = null;
    $all(STEPS[i].selector).forEach(el=>el.classList.remove("active"));
  }
}
function enforceDisabled(){
  STEPS.forEach((s, i)=>{
    const disable = i > state.progress;
    $all(s.selector).forEach(el=>el.classList.toggle("disabled", disable));
  });
}
function handleSelect(stepKey, el){
  const idx = STEPS.findIndex(s=>s.key===stepKey);
  const value = el.dataset[STEPS[idx].dataKey];
  $all(STEPS[idx].selector).forEach(n=>n.classList.remove("active"));
  el.classList.add("active");
  state.selected[stepKey] = value;
  clearAfter(idx);
  if(stepKey === "valor"){ registerEvent(); }else{
    state.progress = Math.min(idx+1, STEPS.length-1);
    refreshBadges(); enforceDisabled();
  }
}
function resetFlow(){
  Object.keys(state.selected).forEach(k=>state.selected[k]=null);
  STEPS.forEach(s=>$all(s.selector).forEach(el=>el.classList.remove("active")));
  state.progress = 0; refreshBadges(); enforceDisabled();
}
function registerEvent(){
  const ev = { ts: new Date().toISOString(), llamada: state.selected.llamada, jugador: state.selected.jugador, accion: state.selected.accion, zona_final: state.selected.zona, valor: state.selected.valor };
  state.events.push(ev);
  refreshBadges(); updateStackedChart(); resetFlow();
}
$all(".opt-llamada").forEach(el=>el.addEventListener("click", ()=>handleSelect("llamada", el)));
$all(".opt-accion").forEach(el=>el.addEventListener("click", ()=>handleSelect("accion", el)));
$all(".opt-zona").forEach(el=>el.addEventListener("click", ()=>handleSelect("zona", el)));
$all(".opt-valor").forEach(el=>el.addEventListener("click", ()=>handleSelect("valor", el)));
const playerInput=$("#playerInput"), addPlayerBtn=$("#addPlayerBtn"), playersList=$("#playersList");
function renderPlayers(){
  playersList.innerHTML = "";
  state.players.forEach(name=>{
    const box = document.createElement("div");
    box.className = "box opt-jugador"; box.dataset.jugador = name; box.textContent = name;
    if(state.selected.jugador===name) box.classList.add("active");
    if(state.progress < 1) box.classList.add("disabled"); else box.classList.remove("disabled");
    box.addEventListener("click", ()=>handleSelect("jugador", box));
    playersList.appendChild(box);
  });
}
function addPlayer(){
  const name = playerInput.value.trim();
  if(!name || state.players.includes(name)) return;
  state.players.push(name); playerInput.value=""; renderPlayers();
  if(state.progress === 1 && !state.selected.jugador){
    const el = playersList.lastElementChild; handleSelect("jugador", el);
  }
}
addPlayerBtn.addEventListener("click", addPlayer);
playerInput.addEventListener("keydown", e=>{ if(e.key==="Enter") addPlayer(); });
function exportCSV(){
  if(state.events.length===0){ alert("No hay eventos."); return; }
  const header = ["timestamp","llamada","jugador","accion","zona_final","valor"];
  const rows = state.events.map(e => [e.ts, e.llamada, e.jugador, e.accion, e.zona_final, e.valor]);
  const csv = [header, ...rows].map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}), url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download=`volley_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
$("#exportCsvBox").addEventListener("click", exportCSV);
$("#resetBtn").addEventListener("click", ()=>{ if(!confirm("¿Vaciar jugadores y eventos?")) return; state.players=[]; state.events=[]; resetFlow(); renderPlayers(); updateStackedChart(); });
const ctx=$("#stackedChart").getContext("2d");
const stacked = new Chart(ctx, {
  type: "bar",
  data: { labels: LLAMADAS, datasets: ACCIONES.map(a => ({ label: a, data: LLAMADAS.map(()=>0) })) },
  options: { responsive: true, plugins: { legend: { position: "top" } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } } } }
});
function updateStackedChart(){
  const counts = {}; ACCIONES.forEach(a => counts[a] = LLAMADAS.reduce((o,l)=>(o[l]=0,o),{}));
  for (const e of state.events){ if(counts[e.accion] && counts[e.accion][e.llamada] !== undefined){ counts[e.accion][e.llamada] += 1; } }
  stacked.data.datasets.forEach((ds, idx)=>{ const action = ACCIONES[idx]; ds.data = LLAMADAS.map(l => counts[action][l]); });
  stacked.update();
}
resetFlow(); renderPlayers(); updateStackedChart();
</script>
</body>
</html>